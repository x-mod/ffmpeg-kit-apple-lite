name: Release FFmpegKit Lite

on:
  push:
    tags:
      - 'v*'

jobs:

  build-ios:
    name: Build iOS
    runs-on: macos-14
    outputs:
      checksum: ${{ steps.checksum.outputs.value }}

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: brew install autoconf automake libtool pkg-config

      - name: Clone ffmpeg-kit
        run: git clone --depth 1 --branch v6.0 https://github.com/arthenica/ffmpeg-kit.git

      - name: Build iOS
        run: |
          chmod +x Scripts/build-ios.sh
          Scripts/build-ios.sh

      - name: Zip iOS
        run: |
          mkdir -p artifacts
          cd ffmpeg-kit/prebuilt
          zip -r ../../artifacts/ffmpegkit-ios.zip apple-ios-xcframework

      - name: Generate checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum artifacts/ffmpegkit-ios.zip)
          echo "value=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: artifacts/ffmpegkit-ios.zip


  build-macos:
    name: Build macOS
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: brew install autoconf automake libtool pkg-config

      - name: Clone ffmpeg-kit
        run: git clone --depth 1 --branch v6.0 https://github.com/arthenica/ffmpeg-kit.git

      - name: Build macOS
        run: |
          chmod +x Scripts/build-macos.sh
          Scripts/build-macos.sh

      - name: Zip macOS
        run: |
          mkdir -p artifacts
          cd ffmpeg-kit/prebuilt
          zip -r ../../artifacts/ffmpegkit-macos.zip apple-macos-xcframework

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: artifacts/ffmpegkit-macos.zip


  release:
    name: Create Release
    needs: [build-ios, build-macos]
    runs-on: macos-14

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ios
          path: artifacts

      - uses: actions/download-artifact@v4
        with:
          name: macos
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/ffmpegkit-ios.zip
            artifacts/ffmpegkit-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}